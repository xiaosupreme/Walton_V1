<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Booking</title>
</head>
<body>
    {% include 'navbar.html' %}
    <h1>Manual Booking</h1>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class=" alert alert-{{category}}" role="alert">
                    {{message}}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <!-- Form for Manual Booking -->
    <form method="POST" id="booking-form">
        <label for="username">Select User:</label>
        <select name="username" required>
            {% for user in users %}
                <option value="{{ user }}">{{ user }}</option>
            {% endfor %}
        </select>
        <br>

        <label for="room_type">Select Room Type:</label>
        <select name="room_type" id="room_type" required>
            {% for type in room_types %}
                <option value="{{ type }}">{{ type }}</option>
            {% endfor %}
        </select>
        <br>

        <label for="room_number">Select Room Number:</label>
        <select name="room_number" id="room_number" required>
            {% for number in room_numbers %}
                <option value="{{ number }}">{{ number }}</option>
            {% endfor %}
        </select>
        <br>

        <label for="start_date">Start Date:</label>
        <input type="date" name="start_date" id="start_date" required>
        <br>

        <label for="end_date">End Date:</label>
        <input type="date" name="end_date" id="end_date" required>
        <br>

        <button type="submit">Create Booking</button>
    </form>

    <!-- JavaScript Section -->
    <script>
        // Set the minimum date for start and end date to today's date
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start_date').setAttribute('min', today);
            document.getElementById('end_date').setAttribute('min', today);

            // Listen for changes to the start date and update the end date accordingly
            document.getElementById('start_date').addEventListener('change', function() {
                const startDate = this.value;
                document.getElementById('end_date').setAttribute('min', startDate);  // End date cannot be before start date
                document.getElementById('end_date').value = '';  // Clear previously selected end date
                updateEndDateOptions();  // Update available end date options based on start date
            });
        });

        // JavaScript to dynamically load room numbers based on selected room type
        document.getElementById('room_type').addEventListener('change', function() {
            const roomType = this.value;
            fetch(`{{ url_for('manual_booking') }}?room_type=${roomType}`)
                .then(response => response.json())
                .then(data => {
                    const roomNumberSelect = document.getElementById('room_number');
                    roomNumberSelect.innerHTML = ''; // Clear the existing options

                    // If there are available room numbers, populate the select element
                    if (data.room_numbers && data.room_numbers.length > 0) {
                        data.room_numbers.forEach(number => {
                            const option = document.createElement('option');
                            option.value = number;
                            option.textContent = number;
                            roomNumberSelect.appendChild(option);
                        });
                    } else {
                        // No available rooms
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'No rooms available';
                        roomNumberSelect.appendChild(option);
                    }
                })
                .catch(error => {
                    console.error('Error fetching room numbers:', error);
                    alert('Failed to fetch available room numbers. Please try again later.');
                });
        });

        // Function to update end date options
        function updateEndDateOptions() {
            const startDate = document.getElementById('start_date').value;
            const endDateInput = document.getElementById('end_date');
            const endDate = new Date(startDate);
            const minEndDate = new Date(startDate);
            minEndDate.setDate(minEndDate.getDate() + 1);  // Set minimum end date to one day after start date

            // Disable dates before the start date and reset end date to valid date
            const minEndDateFormatted = minEndDate.toISOString().split('T')[0];
            endDateInput.setAttribute('min', minEndDateFormatted);
            endDateInput.value = ''; // Reset end date when start date changes
        }

        // Add form validation before submission
        document.getElementById('booking-form').addEventListener('submit', function(event) {
            const startDate = new Date(document.getElementById('start_date').value);
            const endDate = new Date(document.getElementById('end_date').value);

            // Check if the end date is the same or before the start date
            if (endDate <= startDate) {
                event.preventDefault();  // Prevent form submission
                alert('End date must be after the start date.');
                return;
            }

            // Check if the room number is selected
            const roomNumber = document.getElementById('room_number').value;
            if (!roomNumber || roomNumber === 'No rooms available') {
                event.preventDefault();
                alert('Please select a valid room number.');
                return;
            }

            // You can log the form data in the console before submission for debugging purposes
            console.log('User:', document.querySelector('[name="username"]').value);
            console.log('Room Type:', document.querySelector('[name="room_type"]').value);
            console.log('Room Number:', roomNumber);
            console.log('Start Date:', startDate.toISOString().split('T')[0]);
            console.log('End Date:', endDate.toISOString().split('T')[0]);
        });
    </script>
</body>
</html>
